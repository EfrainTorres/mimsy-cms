---
import { getCollection, getEntry } from 'astro:content';
import Base from '../../layouts/Base.astro';

const posts = await getCollection('blog', ({ data }) => !data.draft);

// Resolve author names
const postsWithAuthors = await Promise.all(
  posts.map(async (post) => {
    const author = await getEntry(post.data.author);
    return { ...post, authorName: author?.data.name ?? 'Unknown' };
  })
);

// Sort by date (newest first)
postsWithAuthors.sort((a, b) => {
  const da = a.data.publishedAt?.getTime() ?? 0;
  const db = b.data.publishedAt?.getTime() ?? 0;
  return db - da;
});
---

<Base title="Blog">
  <div class="max-w-3xl mx-auto px-6 py-16">
    <h1 class="text-3xl font-semibold tracking-tight text-stone-900">Blog</h1>
    <p class="mt-2 text-stone-500">Thoughts, tutorials, and updates.</p>

    <div class="mt-10 space-y-8">
      {postsWithAuthors.map((post) => (
        <article>
          <a href={`/blog/${post.id}`} class="group block">
            <h2 class="text-xl font-semibold text-stone-900 group-hover:text-violet-600 transition-colors">
              {post.data.title}
            </h2>
            {post.data.description && (
              <p class="mt-1 text-stone-500">{post.data.description}</p>
            )}
            <div class="mt-2 flex items-center gap-3 text-sm text-stone-400">
              <span>{post.authorName}</span>
              {post.data.publishedAt && (
                <>
                  <span>&middot;</span>
                  <time datetime={post.data.publishedAt.toISOString()}>
                    {post.data.publishedAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                  </time>
                </>
              )}
            </div>
            {post.data.tags.length > 0 && (
              <div class="mt-3 flex gap-2">
                {post.data.tags.map((tag) => (
                  <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-stone-100 text-stone-500">{tag}</span>
                ))}
              </div>
            )}
          </a>
        </article>
      ))}

      {postsWithAuthors.length === 0 && (
        <p class="text-stone-400">No posts yet.</p>
      )}
    </div>
  </div>
</Base>
