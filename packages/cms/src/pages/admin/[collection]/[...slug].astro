---
import AdminLayout from '../../layouts/AdminLayout.astro';
import config from 'virtual:mimsy/config';
import schemas from 'virtual:mimsy/schemas';
import { createAdapter } from '../../../adapters/factory.js';
import EntryEditor from '../../../components/EntryEditor.svelte';

const { collection, slug } = Astro.params;
if (!collection || !slug) return Astro.redirect(config.basePath);

const adapter = await createAdapter(Astro.request, Astro.locals);
const entry = await adapter.getEntry(collection, slug);

if (!entry) {
  return Astro.redirect(`${config.basePath}/${collection}`);
}

// Determine if this is a JSON (data) collection
const isDataCollection = entry.body === '' && entry.rawContent.trim().startsWith('{');

// Get schema fields for this collection (if available)
const schemaFields = schemas[collection] ?? [];

// Recursively collect all reference collections from schema fields
function collectReferenceCollections(fields: typeof schemaFields): Set<string> {
  const refs = new Set<string>();
  for (const f of fields) {
    if (f.type === 'reference' && f.referenceCollection && f.referenceCollection !== '__unknown__') {
      refs.add(f.referenceCollection);
    }
    if (f.objectFields) {
      for (const r of collectReferenceCollections(f.objectFields)) refs.add(r);
    }
    if (f.arrayItemType?.blockConfig) {
      for (const v of f.arrayItemType.blockConfig.variants) {
        for (const r of collectReferenceCollections(v.fields)) refs.add(r);
      }
    }
    if (f.arrayItemType?.objectFields) {
      for (const r of collectReferenceCollections(f.arrayItemType.objectFields)) refs.add(r);
    }
  }
  return refs;
}

const referenceOptions: Record<string, Array<{ slug: string; label: string }>> = {};
for (const refCollection of collectReferenceCollections(schemaFields)) {
  try {
    const refEntries = await adapter.listEntries(refCollection);
    referenceOptions[refCollection] = refEntries.map((e) => ({
      slug: e.slug,
      label: (e.frontmatter.title || e.frontmatter.name || e.slug) as string,
    }));
  } catch {
    referenceOptions[refCollection] = [];
  }
}
---

<AdminLayout title={`Edit: ${entry.slug}`} activeCollection={collection}>
  <EntryEditor
    client:load
    collection={collection}
    slug={slug}
    basePath={config.basePath}
    initialFrontmatter={entry.frontmatter}
    initialBody={entry.body}
    isDataCollection={isDataCollection}
    schemaFields={schemaFields}
    referenceOptions={referenceOptions}
  />
</AdminLayout>
