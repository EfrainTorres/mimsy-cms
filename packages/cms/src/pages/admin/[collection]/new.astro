---
import AdminLayout from '../../layouts/AdminLayout.astro';
import config from 'virtual:mimsy/config';
import schemas from 'virtual:mimsy/schemas';
import { createAdapter } from '../../../adapters/factory.js';
import NewEntryForm from '../../../components/NewEntryForm.svelte';
import matter from 'gray-matter';

const { collection } = Astro.params;
if (!collection) return Astro.redirect(config.basePath);

const adapter = await createAdapter(Astro.request, Astro.locals);

// Determine if this is a data (JSON) collection by checking existing entries
const entries = await adapter.listEntries(collection);
const isDataCollection = entries.length > 0
  ? entries[0].body === '' && entries[0].rawContent.trim().startsWith('{')
  : false;

// Get schema fields for this collection (if available)
const schemaFields = schemas[collection] ?? [];

// Recursively collect all reference collections from schema fields
function collectReferenceCollections(fields: typeof schemaFields): Set<string> {
  const refs = new Set<string>();
  for (const f of fields) {
    if (f.type === 'reference' && f.referenceCollection && f.referenceCollection !== '__unknown__') {
      refs.add(f.referenceCollection);
    }
    if (f.objectFields) {
      for (const r of collectReferenceCollections(f.objectFields)) refs.add(r);
    }
    if (f.arrayItemType?.blockConfig) {
      for (const v of f.arrayItemType.blockConfig.variants) {
        for (const r of collectReferenceCollections(v.fields)) refs.add(r);
      }
    }
    if (f.arrayItemType?.objectFields) {
      for (const r of collectReferenceCollections(f.arrayItemType.objectFields)) refs.add(r);
    }
  }
  return refs;
}

const referenceOptions: Record<string, Array<{ slug: string; label: string }>> = {};
for (const refCollection of collectReferenceCollections(schemaFields)) {
  try {
    const refEntries = await adapter.listEntries(refCollection);
    referenceOptions[refCollection] = refEntries.map((e) => ({
      slug: e.slug,
      label: (e.frontmatter.title || e.frontmatter.name || e.slug) as string,
    }));
  } catch {
    referenceOptions[refCollection] = [];
  }
}

// Load content template via adapter (works for both local and GitHub)
let templateBody = '';
let templateFrontmatter: Record<string, unknown> = {};

const mdTemplate = await adapter.getFileContent(`_templates/${collection}.md`);
if (mdTemplate) {
  try {
    const parsed = matter(mdTemplate);
    templateBody = parsed.content.trim();
    templateFrontmatter = parsed.data ?? {};
  } catch {
    // Template parsing failed; continue without template
  }
} else {
  const jsonTemplate = await adapter.getFileContent(`_templates/${collection}.json`);
  if (jsonTemplate) {
    try {
      templateFrontmatter = JSON.parse(jsonTemplate);
    } catch {
      // Template parsing failed; continue without template
    }
  }
}
---

<AdminLayout title={`New ${collection}`} activeCollection={collection}>
  <NewEntryForm
    client:load
    collection={collection}
    basePath={config.basePath}
    isDataCollection={isDataCollection}
    schemaFields={schemaFields}
    referenceOptions={referenceOptions}
    templateBody={templateBody}
    templateFrontmatter={templateFrontmatter}
  />
</AdminLayout>
